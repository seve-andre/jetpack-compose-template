name: linting-on-pr

on:
  pull_request:
    paths:
      - 'app/**'
      - '**/*.kt'
      - '**/*.kts'
      - 'gradle/**'
      - '.github/workflows/linting-on-pr.yml'

jobs:
  lint:
    name: Lint & Detekt
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          validate-wrappers: true
          gradle-home-cache-cleanup: true

      - name: Detect changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            kotlin:
              - '**/*.kt'
              - '**/*.kts'
            android:
              - 'app/src/**'
              - 'lint/src/**'

      - name: Run Detekt
        if: steps.changes.outputs.kotlin == 'true'
        run: ./gradlew detektMain --build-cache --parallel --configuration-cache

      - name: Upload Detekt reports (HTML)
        if: steps.changes.outputs.kotlin == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: '**/build/reports/detekt/*.html'

      - name: Run Android Lint
        if: steps.changes.outputs.android == 'true'
        run: ./gradlew :app:lintProdRelease --build-cache --parallel --configuration-cache

      - name: Upload lint reports (HTML)
        if: steps.changes.outputs.android == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: '**/build/reports/lint-results-*.html'
